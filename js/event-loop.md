# В поликлинике (PG-63)

## Заболели?

На этот раз нас врасплох опять застал этот чертов коронавирус. Настало время идти к врачу, больничный открывать. 
Позвонили в регистратуру, взяли талон на ближайшее. Заходим в поликлинику, а там всё как всегда, длиннющая очередь, 
ворчащие бабульки, и очередь никуда не движется… У нас талон по времени, но всё равно нужно спросить, по очереди 
или по талонам принимают. Выяснится, что у нас что-то среднее, по талонам, но люди в очереди с дополнительными 
талонами тоже всех пропускать не намерены. Мы застряли если не на века, то на день точно… Что делать? Сидеть, 
пялиться в телефон. Батарея разряжена, телефон на зарядку ночью не поставил, да блииин… Начинаем думать, 
представлять, анализировать. Следить за событиями вокруг, искать закономерности, аналогии.

Спустя час изнурительной скуки какой-то идиот без маски проходя мимо нас чихнул прямо в нашу сторону, не 
извинился даже, пошел дальше. Одно слово - нехороший человек. Ой, два... Мы стараемся не дышать, отвернуться в сторону, 
выйти подышать на крыльцо свежим воздухом, вдруг поможет, вдруг не заболеем ещё сильнее… Но уже чувствуем затылком, что мы 
заражены, и этот вирус начинает проникать в нас, поглощает нас целиком медленно, но верно. Мы инфицированы **JavaScript**.

## Полный хаос

Нас бросает в жар, мы начинаем кричать какие-то отрывки фраз невпопад, форменный бред… Нас метает из стороны в сторону, 
мы не можем себя контролировать. Люди в коридоре начинают шушукаться, из толпы слышны предположения про синдром Туретто,
кто-то предположил лихорадку, потому что у нас мозг закипел, но это очень далеко от истины. 
Всё намного хуже, мы впали в **асинхрон**. И выбраться из него уже невозможно. Нужно научиться жить 
в новом миропредставлении. Ещё час назад время текло линейно и понятно, а сейчас недосказанные резкие предложения 
всплывали посреди другой спокойной и, казалось бы, вполне обычной речи. Прошёл ещё один час…

Мы привыкаем смотреть на окружающий нас мир новыми глазами, пытаемся осознать всё по-новому. 
И созерцание очереди нас успокаивает. Мы это замечаем и начинаем жадно, будто не ели третий день, 
поглощать всю доступную информацию об этой злосчастной **очереди**. Чем больше мы узнаем о ней, тем проще нам 
понять себя, хотя казалось бы, причем тут ворчливые бабульки и крики какой-то женщины у двери... 
В какой-то момент мы укрощаем хаос, начинаем жить в гармонии с собой. Ведь увидели истину, нашли ответ. 
Как же это прекрасно. Очередь совсем не уродлива, бабульки нас уже не пугают, а возможность проскочить 
повторно в кабинет, не дав зайти следующему пациенту, нас даже уже восхищает…

## Метание по кругу

Всё было на самом виду, наша очередь есть очередь **макрозадач**. Каждый пациент - задача, которую нужно решить. 
Чтобы попасть на прием, мы берем талон по времени и приходим в поликлинику в строго определенное время. 
Но сразу нас никто не пустит, у кабинета нас встретит очередь незадачливых пациентов, чьё время тоже уже давно прошло, 
а приема всё ещё ждут… Никто нам не гарантирует выполнения задачи в срок, а по возможности **в порядке очереди**, эх. 
Теперь понятно, как работают **setTimeout** и **setInterval**. Это регистратура, которая назначает время, 
когда вы должны прийти, и им всё равно, обслужат вас там или нет…

Но если происходит что-то невообразимое, что-то страшное, **событие**, одним словом, то мы прибегаем в регистратуру 
и просим ближайшего приема у сейчас принимающего врача. Нам дают дополнительный талончик, и мы бежим скорее 
занять очередь, без очереди нас точно не пустят. Все ворчащие бабульки в ней нас обматерят, а может и чего хуже. 
Добро пожаловать в постановку в очередь по событию. Без очереди, к сожалению, нас не пустят, но за непропуск вновь 
прибывающих людей с талонами по времени мы ещё поборемся, их **не пропустить** для нас дело чести!

Господи, да почему же так долго тянется прием, почему очередь стоит на месте? Мы не можем уже больше ждать, 
начинаем метаться, подходим поближе к двери, чтобы проследить, что тут происходит. И что мы видим, 
да это же безобразие! Уже собралась вторая очередь из людей, которым не терпится ворваться в кабинет, 
и это явно не люди из основной очереди… Эти люди уже точно знают, зачем им, они всем твердят, что они **по-быстрому**, 
у них **в руках уже результаты** каких-то анализов, исследований, осмотров. Они дождутся, пока врач освободится, 
и сразу вбегут в кабинет. И самое страшное, что таких людей уже скопилось несколько за время приёма текущего пациента! 
Они даже организовали собственную очередь, поначалу назвали себя очередью по-быстрому, но кто-то самый умный язвительно 
их назвал **микрозадачами**. И зачем только врач **пообещал их обслужить по результату**… 
Обработка результатов **промисов** - игра с огнём. Если эти пациенты не будут вылетать пулей из кабинета, 
то в очереди назреет большая проблема! Слава богу, эта очередь микрозадач быстро пустеет, и снова всё возвращается 
на круги своя, ещё один человек заходит в кабинет из нашей длиннющей и ворчащей без конца очереди. 
Спустя 3 часа изнурительного ожидания, мы подбираемся к заветной двери, успех совсем близок, казалось бы…

## Очередь в один кабинет, большая поликлиника и множество дверей. Вычеркни лишнее

Момент несказанной радости, экстаза, ведь двери открываются, а перед нами никого,- это победа! 
Такое примитивное мышление выдает в нас новичка. Прожженные бабульки бы сидели не шелохнувшись, 
кто захочет потерять сидячее место по ложной тревоге?! Ведь дверь открыл не пациент, а врач, он куда-то ушёл. 
На лицо явные проблемы, бедный врач разрывается между разными процессами, поликлиники перегружены (**процессор**)… 
Слава богу, врач вернулся, снова ждём шевеления ручки двери, как Хатико своего хозяина. Хатико, поди, 
не хватило бы терпения, но мы героически терпим и ждём.

Двери снова открываются, и вот оно, пациент вышел, и захожу я, ура! Сейчас врач меня посмотрит, а я с чистой совестью 
и чувством выполненного долга отправлюсь домой. Врач уточняет у медсестры, где же моя карточка, но мне её не доверяют. 
Она большая, с кучей информации, у нас на руках от силы пара маленьких бумажек с парой результатов анализов и всё. 
Я **ссылаюсь** на то, что карточка, должно быть, в регистратуре, в **куче** других карточек. Не проблема, 
медсестра пулей метнулась **по ссылке** и подогнала вожделенный **объект**. Пошёл процесс!

Медсестра начинает куда-то звонить, там требует выписки какие-то, что-то заказывает в лаборатории, время тянется… 
Благо хотя бы лаборатория работает самостоятельно, меня это не касается. Чем-то напомнило мне обращения в **Web Api**, 
чью работу мы не наблюдаем, она проходит эффективно, в ней даже может участвовать куча врачей, 
а мы просто ждем результата выполнения. Пытаюсь прислушаться, что там бурчат за закрытой дверью, 
но будто кричат что-то на совсем другом языке, как странно…

Что-то взгляд врача мне не нравится, что-то не так. Врач просит меня пройти УЗИ и посмотреть ЭКГ, ой не к добру всё это… 
Медсестра берёт карту, чтобы **не потерять контекст** беседы о пациенте, ведёт меня на ЭКГ, там меня принимают, 
обслуживают, и дают результат, с которым я возвращаюсь к лечащему врачу. А тем временем, вся очередь меня ненавидит 
и прожигает своим взглядом, ведь пока медсестра ходила со мной, приём был приостановлен, все были заняты задачей 
постановки именно моего диагноза. Какой стыд. Благо, получив результаты на бумажке, мне уже не нужна никакая 
информация из кабинета ЭКГ, и на том слава богу, сей контекст можно забыть, как в страшном сне. Опять в голове 
всплывают какие-то ассоциации со **стэком выполнения задачи**. Чего я уже не узнаю, так это то, что медсестра 
прихватила по ошибке другую карточку, и в кабинете ЭКГ поработали с совсем иными данными, и ещё далеко не факт, 
что это не сказалось на результате, ведь **контекст был подменен**… Слава богу, что хотя бы сердце моё послушали, 
а не соседа по кушетке, вроде бы. Врач не обратил внимания, и отправил на УЗИ. 

Но обработку его результатов нужно ждать, поэтому мы сбегали на узи с медсестрой (да простит нас очередь), а меня, 
тем временем, медсестра оставила ждать под дверью результатов. Сама же вернулась в свой кабинет, чтобы продолжить приём. 
Ой, как я надеюсь, что за время ожидания результата УЗИ, все, кто меня помнит, уже пройдут через этот чертов кабинет. 
Пусть лучше новые проклинают, когда я буду ломиться без очереди, чем буду умирать от стыда на глазах у старых знакомых 
по несчастью. Вот результаты уже готовы, я бегу сломя голову обратно к кабинету, а там опять 2 очереди, аж полегчало, 
не придется ничего объяснять, просто стану в очередь микрозадач, ведь здесь я уже ориентируюсь, взгляд мой хладнокровный. 
Остаётся дождаться несчастного приема и пойти домой.

Но ситуация скверная, мне явно нужно пролечиться в больнице, и отправиться туда нужно немедленно. 
Врач клянется, что примет меня как только, так сразу, будет ждать и верить в мое выздоровление. 
Но в больницу с моей карточкой нельзя. Её регистратура не отдаст. Она принадлежит ей и только ей. 
Другие поликлиники и больницы и знать её не хотят. Всё, что им нужно, это небольшая выписка с краткими, 
но очень ценными данными обо мне, в руки дают её и отправляют в больницу на специальной скорой. 
От бывалых я потом узнаю, что это был **веб-воркер**. Меня отправили в совсем иной процесс лечения, 
где ничего не знают о поликлинике, а только принимают **простые данные на вход и сообщают такие же простые данные в результате на выходе**. 
Ну ещё о статусе лечения по запросу могут сообщить. Интересно, что они скрывают? 
Откуда такая тотальная секретность и безопасность? Как странно, но мы врачу ничего не сможем сообщить об этом, 
как и наш врач **не сможет дать инструкции по проведению процесса лечения**, разве только написать записку, 
да прилепить её к выписке. Но правильно ли прочтёт этот **текст** врач из больницы - никаких гарантий. 
Почерк у них у всех скверный. Странно это всё. **Сериализация** какая-то...

## Бессмыслица какая-то

Можно было сделать по-другому, наверно. Но и так работает, пациенты принимаются, лечатся. Медленные пациенты злят, 
но создают лишь временные трудности. Зато врачи реагируют оперативно на результаты и отправляют на лечение. 
Видимо, таких принципов работы системе здравоохранения достаточно. Какое-то чертово колесо, замкнутый круг, 
по которому нас всех водят… Но меня это устраивает.

Я выздоровел, мне полегчало, и лихорадка Асинхрона ко мне больше не возвращалась. Говорят, что это 
хроническое заболевание, но симптомы купируются почти полностью, и оно никак не мешает мне жить. 
Зато стало легче ходить к врачу и не теряться в бесконечных дверях да направлениях.

Для новичков же я приклеил записку на двери в поликлинику, чтобы люди с лихорадкой Асинхрона скорее возвращались к полноценной жизни:

* **Event-Loop** - процесс обслуживания пациентов в поликлинике врачами. Мы записываемся на прием и приходим по времени в очередь макрозадач.

* **Очередь Макрозадач** - сюда помещаются все наши задачи (пациенты с болезнью, а диагностика и лечение - операции, которые выполняет врач).

* Талоны пациентам выдаются регистратурой либо **по времени** (их можно получить при помощи **setInterval** или **setTimeout**), 
либо прийти в регистратуру и потребовать талон на приём прямо сейчас, если у нас что-то случилось (какое-то событие). 
Нас **никто не пустит без очереди**, но мы можем стать последними, и не пропускать никакие другие талоны по времени. 
А **талон по времени не гарантирует**, что будет выполнен в назначенный час, ибо живую (пока ещё) очередь никто не отменял.

* Нам придется **пропускать пациентов**, которые посещают врача повторно, ведь их поместят в другую быструю очередь. 
Медсестра подтвердит, что у них приоритет. Это очередь **Микрозадач**. Сложные и медленные операции в ней нарушат 
работу общей очереди, поэтому таких пациентов нужно отпускать максимально быстро. В эту очередь можно попасть 
по повторному приему(врач обещает принять без очереди, то есть создает **Promise**), либо мы можем оплатить 
какие-то дорогие услуги, и нас любезно поместят в эту же сверхсрочную очередь (при помощи **queueMicroTask**). 
Но очереди никто не отменял, выгнать пациента из кабинета все равно нельзя, а жаль. Я бы заплатил за это удовольствие...

* Существует возможность передать ход лечения конкретного пациента в больницу, но это совершенно другой процесс 
со своими инструкциями (отдельно запущенный скрипт). Это реализовано через **Веб-Воркеры**. 
В другой процесс можно передать только примитивные (**сериализируемые**) данные (JSON). 
Оттуда же придет ответ по окончанию в таком же виде (сериализируемые данные). Общение с ним будет проходить **асинхронно**. 
При этом задача в воркере выполняется в ином процессе (что обеспечивает возможность многопоточных вычислений)